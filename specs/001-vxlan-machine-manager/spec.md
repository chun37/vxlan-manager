# Feature Specification: VXLANマシン管理システム

**Feature Branch**: `001-vxlan-machine-manager`
**Created**: 2025-10-18
**Status**: Draft
**Input**: User description: "VXLANネットワーク内のマシンを自動登録・監視し、接続状態をリアルタイムで管理するシステム"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - マシン自動登録と一覧表示 (Priority: P1)

管理者が、VXLANネットワーク内の各マシンから自動的に登録情報を受け取り、Webブラウザで一覧表示できる。

**Why this priority**: システムの最も基本的な機能であり、これがなければ監視機能も意味をなさない。マシンの可視化は運用の第一歩。

**Independent Test**: マシンから登録情報を送信し、Web画面で該当マシンが一覧に表示されることを確認。既に登録されているマシンの情報を再送信すると情報が更新されることを確認。

**Acceptance Scenarios**:

1. **Given** マシンがVXLANネットワークに接続されている, **When** マシンが自身の情報(ホスト名、IPアドレス、MACアドレス)を送信する, **Then** Web画面のマシン一覧に新しいマシンが表示される
2. **Given** マシンが既に登録されている, **When** 同じIPアドレスから異なるホスト名で情報を送信する, **Then** 既存のマシン情報が更新され、一覧に重複エントリは表示されない
3. **Given** 管理者がWebブラウザで管理画面にアクセスしている, **When** 画面を開く, **Then** すべての登録済みマシンの一覧(ホスト名、IPアドレス、MACアドレス)が表示される

---

### User Story 2 - リアルタイム死活監視 (Priority: P2)

管理者が、登録されたマシンの接続状態をリアルタイムで監視でき、接続不可になったマシンを即座に把握できる。

**Why this priority**: マシンが登録されただけでは十分でなく、現在稼働しているかどうかをリアルタイムで知る必要がある。障害対応の迅速化に直結する。

**Independent Test**: マシンの電源を切るか、ネットワークを切断し、Web画面上で該当マシンのステータスが「接続不可」に変わることを確認。誤検知を防ぐため、一時的なネットワーク障害では即座に切断判定されないことも確認。

**Acceptance Scenarios**:

1. **Given** マシンが登録されており接続中である, **When** マシンへの接続が3回連続で失敗する, **Then** Web画面上でそのマシンのステータスが「接続不可」に変更され、管理者に視覚的に通知される
2. **Given** マシンが接続不可状態である, **When** マシンが再び応答可能になる, **Then** Web画面上でそのマシンのステータスが「接続中」に自動的に変更される
3. **Given** マシンへの接続が1回失敗した, **When** 次の確認で成功する, **Then** 失敗カウントがリセットされ、接続不可判定にならない
4. **Given** 管理者がWeb画面を開いている, **When** マシンの状態が変化する, **Then** ページをリロードせずに状態が自動更新される

---

### User Story 3 - モバイル対応とマシン削除 (Priority: P3)

管理者が、スマートフォンやタブレットからも快適にマシンの状態を確認でき、接続不可のマシンを削除できる。

**Why this priority**: 管理者は常にデスクトップの前にいるわけではなく、現場や移動中でも状態確認が必要。また、接続不可マシンの整理も運用上重要。

**Independent Test**: スマートフォンのWebブラウザで管理画面にアクセスし、横スクロールなしで全情報が閲覧できることを確認。接続不可のマシンを選択し、削除ボタンから確認ダイアログを経て削除が完了することを確認。

**Acceptance Scenarios**:

1. **Given** 管理者がスマートフォンでWeb画面にアクセスしている, **When** 画面を表示する, **Then** すべてのマシン情報が横スクロールなしで閲覧でき、タッチ操作で快適に操作できる
2. **Given** 接続不可のマシンが一覧に表示されている, **When** 管理者が削除ボタンをクリックする, **Then** 削除確認ダイアログが表示され、マシン情報(ホスト名、IP、MAC)が確認できる
3. **Given** 削除確認ダイアログが表示されている, **When** 管理者が削除を確定する, **Then** マシンが一覧から削除され、削除前の情報がログに記録される
4. **Given** 削除確認ダイアログが表示されている, **When** 管理者がキャンセルする, **Then** マシンは削除されず一覧に残る

---

### Edge Cases

- マシンが1000台に達したとき、新規登録は受け付けられるか? → システムは最大1000台まで管理でき、それを超える登録は拒否される
- 同時に複数のマシンから登録リクエストが来た場合、すべて正常に処理されるか? → システムは並行処理により複数の同時登録を受け付ける
- WebSocket接続が切断された場合、ユーザーはどのように通知されるか? → 自動的に再接続を試み、接続が回復するまで警告を表示
- 無効なIPアドレスやMACアドレスが送信された場合、どう処理されるか? → 入力検証により不正なデータは拒否され、エラーメッセージが返される
- pingが一時的に失敗したが、すぐに回復した場合、不必要なアラートは出ないか? → Exponential Backoffにより3回連続失敗するまで接続不可と判定しないため、誤検知を最小化
- データベース接続が失われた場合、システムはどう振る舞うか? → エラーを適切にハンドリングし、ユーザーにメンテナンス中のメッセージを表示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、マシンからHTTP経由で登録情報(ホスト名、IPアドレス、MACアドレス)を受信し、データベースに保存しなければならない
- **FR-002**: システムは、同一IPアドレスからの登録を検出し、既存情報を更新(Upsert操作)しなければならない
- **FR-003**: システムは、登録済みマシンに対して定期的に接続確認を実施しなければならない
- **FR-004**: システムは、マシンへの接続が3回連続で失敗した場合、そのマシンを「接続不可」と判定しなければならない
- **FR-005**: システムは、接続確認の失敗回数に応じて、再試行間隔を段階的に延長(Exponential Backoff: 60秒→120秒→240秒→480秒...最大3600秒)しなければならない
- **FR-006**: システムは、マシンの状態変化(接続中⇔接続不可)を即座にWeb画面にプッシュ通知しなければならない
- **FR-007**: システムは、すべての登録済みマシンの一覧(ホスト名、IPアドレス、MACアドレス、接続状態、最終確認時刻)を表示しなければならない
- **FR-008**: システムは、管理者が接続不可のマシンを手動で削除できる機能を提供しなければならない
- **FR-009**: システムは、マシン削除前に確認ダイアログを表示し、誤削除を防止しなければならない
- **FR-010**: システムは、接続不可と判定されたマシンの情報(ホスト名、IPアドレス、MACアドレス、検出日時)をログとして記録しなければならない
- **FR-011**: システムは、最大1000台のマシンを管理でき、それを超える新規登録は拒否しなければならない
- **FR-012**: システムは、マシン登録時に拡張フィールド(JSONB形式)を受け入れ、将来の機能拡張に対応しなければならない

### Key Entities

- **Machine(マシン)**: VXLANネットワーク内の管理対象デバイス。主要属性: ホスト名、IPアドレス(一意識別子)、MACアドレス、接続状態(接続中/接続不可)、最終確認時刻、登録日時、更新日時、拡張データ
- **Ping Status(接続状態)**: マシンの死活監視結果。主要属性: 対象マシン、生存フラグ、応答時間、確認日時、連続失敗回数、次回確認間隔。Machineに紐づく
- **Failure Log(障害ログ)**: 接続不可と判定されたマシンの記録。主要属性: 対象マシン、ホスト名、IPアドレス、MACアドレス、検出日時。Machineに紐づき、削除されても履歴として保持

### Non-Functional Requirements *(mandatory - constitution compliance)*

#### Security Requirements
- **NFR-SEC-001**: IPアドレスとMACアドレスの形式検証を実施し、不正なデータを拒否しなければならない
- **NFR-SEC-002**: データベースクエリはパラメータバインディングを使用し、SQLインジェクション攻撃を防止しなければならない
- **NFR-SEC-003**: Web画面に表示されるすべてのユーザー入力データはHTMLエスケープされ、XSS攻撃を防止しなければならない
- **NFR-SEC-004**: 同一IPアドレスからのマシン登録リクエストにレート制限を適用し、DoS攻撃を緩和しなければならない

#### Performance Requirements
- **NFR-PERF-001**: マシン登録リクエストに対して1秒以内に応答しなければならない
- **NFR-PERF-002**: システムは最大1000台のマシンを同時監視できなければならない
- **NFR-PERF-003**: データベースクエリ(一覧取得)は通常負荷時に100ミリ秒以内に完了しなければならない
- **NFR-PERF-004**: WebSocketを通じた状態更新通知は、状態変化から1秒以内にクライアントに配信されなければならない
- **NFR-PERF-005**: Ping監視処理は最大100台を並列実行し、効率的にリソースを使用しなければならない

#### Architecture Requirements
- **NFR-ARCH-001**: すべてのI/O操作(データベースアクセス、ネットワーク通信、ping実行)は非同期で実装されなければならない
- **NFR-ARCH-002**: リアルタイム状態更新はWebSocketを使用し、ポーリング方式は採用しないこと
- **NFR-ARCH-003**: すべてのデータベース操作はトランザクション内で実行され、エラー時は適切にロールバックされなければならない

#### UI/UX Requirements
- **NFR-UI-001**: Web画面はデスクトップ、タブレット、スマートフォンのすべてで正常に表示され、操作可能でなければならない
- **NFR-UI-002**: スマートフォン表示時、横スクロールなしですべての情報が閲覧可能でなければならない
- **NFR-UI-003**: マシンの状態変化はページリロードなしで即座に反映されなければならない

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者は、マシンが登録情報を送信してから5秒以内にWeb画面でそのマシンを確認できる
- **SC-002**: システムは1000台のマシンを同時監視しても、個々のping確認が60秒間隔で遅延なく実行される
- **SC-003**: マシンの接続が失われてから、最大12分以内(3回の再試行: 60秒+120秒+240秒)に接続不可と判定され、Web画面に反映される
- **SC-004**: 管理者がスマートフォンからアクセスしたとき、マシン一覧がカード形式で表示され、横スクロールなしに全情報が閲覧できる
- **SC-005**: Web画面を開いている管理者は、別のマシンの状態が変化したとき、ページリロードせずに1秒以内にその変化を視覚的に確認できる
- **SC-006**: 接続不可マシンの削除操作は、削除ボタンのクリックから確認ダイアログ、削除完了まで10秒以内に完了する
- **SC-007**: システムは100台以上のマシンから同時に登録リクエストを受信しても、すべて正常に処理し、データ損失が発生しない
- **SC-008**: マシン一覧表示のレスポンスタイムは、1000台登録時でも500ミリ秒以内である
